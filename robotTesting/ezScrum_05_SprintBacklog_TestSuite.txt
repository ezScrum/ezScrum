*** Settings ***
Force Tags        SprintBacklog
Resource          keywords/common_resource.txt
Resource          keywords/ezScrum_Login.txt
Resource          keywords/Project/ezScrum_Project.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Story.txt
Resource          keywords/ProductBacklog/ezScrum_ProductBacklog_Tag.txt
Resource          keywords/SprintPlan/ezScrum_SprintPlan_Sprint.txt
Resource          keywords/SprintBacklog/ezScrum_SprintBacklog_Story.txt
Resource          keywords/SprintBacklog/ezScrum_SprintBacklog_Task.txt
Resource          keywords/SprintBacklog/ezScrum_SprintBacklog_Sprint.txt
Resource          keywords/SprintBacklog/ezScrum_SprintBacklog_SetupTeardown.txt
Resource          Global Define.txt
Resource          ServerConfig.txt
Library           BuiltIn
Library           Collections
Library           keywords/lib/Selenium2Improved.py

*** Test Cases ***
Test Sprint Backlog - Edit Story
    [Setup]    Test Sprint Backlog - Edit Story Setup
    # story information
    ${oriStoryName}=    Set Variable    add story for test edit story
    ${updateStoryName}=    Set Variable    update story for test edit story
    ${value}=    Set Variable    3
    ${estimate}=    Set Variable    5
    ${importance}=    Set Variable    8
    ${notes}=    Set Variable    update story for notes
    ${howToDemo}=    Set Variable    update story for how to demo
    # 編輯story information並回傳story id
    Comment    ${storyId}=    Edit Story With Arguments In Sprint Backlog    ${oriStoryName}    ${updateStoryName}    ${value}    ${estimate}
    ...    ${importance}    ${notes}    ${howToDemo}
    # 驗證story information
    Comment    Verify Story Information With Arguments In Sprint Backlog    ${updateStoryName}    ${value}    ${estimate}    ${importance}    ${EMPTY}
    ...    ${notes}    ${howToDemo}
    [Teardown]    Test Sprint Backlog - Edit Story Teardown

Test Sprint Backlog - Add Story
    [Setup]    Test Sprint Backlog - Add Story Setup
    # story information
    ${storyName}=    Set Variable    add story for test add story
    ${value}=    Set Variable    3
    ${estimate}=    Set Variable    5
    ${importance}=    Set Variable    8
    ${notes}=    Set Variable    add story for notes
    ${howToDemo}=    Set Variable    add story for how to demo
    # add story
    Comment    Create Story With Arguments    ${storyName}    ${value}    ${estimate}    ${importance}    ${EMPTY}
    ...    ${notes}    ${howToDemo}
    # 驗證story information
    Comment    Verify Story Information With Arguments In Sprint Backlog    ${storyName}    ${value}    ${estimate}    ${importance}    ${EMPTY}
    ...    ${notes}    ${howToDemo}
    [Teardown]    Test Sprint Backlog - Add Story Teardown

Test Sprint Backlog - Drop Story
    [Setup]    Test Sprint Backlog - Drop Story Setup
    # story information
    ${oriStoryName}=    Set Variable    add story for test drop story
    ${storyID}=    Get Story ID In Sprint Backlog    ${oriStoryName}
    # 驗證未 drop story 前的sprint
    Select Node Product    Product Backlog
    ${storySprint}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${storyID}")]/../.././/div[@class="x-grid3-cell-inner x-grid3-col-5"]
    Comment    Should Be Equal    ${storySprint}    1
    # drop story
    Select Node Product    Sprint Backlog
    Drop Story    ${oriStoryName}
    # 驗證 sprint backlog
    Page Should Not Contain Element    xpath=//div[@class="x-treegrid-text" and (text()="${storyID}")]/../../td[1]/a/span
    # 驗證 product backlog
    Select Node Product    Product Backlog
    ${storySprint}=    Get Text    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${storyID}")]/../.././/div[@class="x-grid3-cell-inner x-grid3-col-5"]
    Should Be Equal    ${storySprint}    None
    [Teardown]    Test Sprint Backlog - Drop Story Teardown

Test Sprint Backlog - Add Existing Story
    [Setup]    Test Sprint Backlog - Add Existing Story Setup
    Sleep    3s
    Select Node Product    Sprint Backlog
    ${storyName}=    Set Variable    Test Story 01
    ${value}=    Set Variable    3
    ${estimate}=    Set Variable    5
    ${importance}=    Set Variable    99
    ${notes}=    Set Variable    Notes
    ${howToDemo}=    Set Variable
    # Click add existing story window
    Comment    Add Existing Story    ${storyName}
    # Verify story
    Sleep    2s
    Comment    Verify Story Information With Arguments In Sprint Backlog    ${storyName}    ${value}    ${estimate}    ${importance}    ${EMPTY}
    ...    ${notes}    ${howToDemo}
    [Teardown]    Test Sprint Backlog - Add Existing Story Teardown

Test Sprint Backlog - Edit Sprint
    [Setup]    Test Sprint Backlog - Edit Sprint Setup
    ${sprintId}=    Get Text    //div[text()="sprint1 sprint goal"]/../../td[1]/div    #//div[@id="SprintPlan_Page_Layout"]//div/table/tbody//tr//td/div[text()="sprint1 sprint goal"]/../../td[1]/div
    ${sprintGoal}=    Set Variable    update sprint goal
    ${sprintInterval}=    Set Variable    3
    ${sprintMembers}=    Set Variable    5
    ${sprintAvaliableDays}=    Set Variable    116
    ${sprintFocusFactor}=    Set Variable    50
    # update sprint information
    Edit Sprint In Sprint Backlog    ${sprintGoal}    ${sprintInterval}    ${sprintMembers}    ${sprintAvaliableDays}    ${sprintFocusFactor}
    Wait Until Page Contains    Success.
    # verify sprint information in Sprint Backlog
    ${sprintInformation}=    Get Text    xpath=//div[@id="SprintBacklog_Page_Event"]/div[1]
    Should Be Equal As Strings    ${sprintInformation}    Release #None ; Sprint #${sprintId} - ${sprintGoal} | Story Point : 0 ; Task Hours : 0 ; Total Hours to Commit : 58
    # verify sprint information in Sprint Plan
    Select Node Product    Sprint Plan
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-0" and (text()="${sprintId}")]    1
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-1" and (text()="${sprintGoal}")]    1
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-3" and (text()="${sprintInterval}")]    1
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-6" and (text()="${sprintMembers}")]    1
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-7" and (text()="${sprintAvaliableDays} hours")]    1
    Xpath Should Match X Times    //div[@class="x-grid3-cell-inner x-grid3-col-8" and (text()="${sprintFocusFactor}")]    1
    [Teardown]    Test Sprint Backlog - Edit Sprint Teardown

Test Sprint Backlog - Add Task
    [Setup]    Test Sprint Backlog - Add Task Setup
    # task information
    ${taskName}=    Set Variable    task 1 for add task
    ${taskEstimate}=    Set Variable    3
    ${taskRemains}=    Set Variable    3
    ${taskNotes}=    Set Variable    notes for add task
    # new task
    Comment    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    Comment    Add Task With Arguments    ${storyID}    ${taskName}    ${taskEstimate}    ${taskNotes}
    # verify task information in Sprint Backlog
    Comment    Verify Task Information With Arguments    ${storyName}    ${taskName}    ${EMPTY}    ${EMPTY}    ${taskEstimate}
    ...    ${taskRemains}    0    ${taskNotes}
    [Teardown]    Test Sprint Backlog - Add Task Teardown

Test Sprint Backlog - Edit Task
    [Setup]    Test Sprint Backlog - Edit Task Setup
    Comment    # task information
    Comment    ${oriTaskName}=    Set Variable    task 1 for edit task
    Comment    ${oriTaskEstimate}=    Set Variable    3
    Comment    ${oriTaskNotes}=    Set Variable    notes for edit task
    Comment    # new task
    Comment    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    Comment    Add Task With Arguments    ${storyID}    ${oriTaskName}    ${oriTaskEstimate}    ${oriTaskNotes}
    Comment    # edit task
    Comment    ${updateTaskName}=    Set Variable    update task 1 name
    Comment    ${updateTaskEstimate}=    Set Variable    5
    Comment    ${updateTaskRemains}=    Set Variable    5
    Comment    ${updateTaskActual}=    Set Variable    5
    Comment    ${updateTaskNotes}=    Set Variable    notes for update task 1 notes
    Comment    ${taskID}=    Get Task ID In Sprint Backlog    ${oriTaskName}
    Comment    Edit Task With Arguments    ${taskID}    ${oriTaskName}    ${EMPTY}    ${EMPTY}    ${updateTaskName}
    ...    ${updateTaskRemains}    ${updateTaskActual}    ${updateTaskNotes}
    Comment    # verify task information in Sprint Backlog
    Comment    Verify Task Information With Arguments    ${storyName}    ${updateTaskName}    ${EMPTY}    ${EMPTY}    ${oriTaskEstimate}
    ...    ${updateTaskRemains}    ${updateTaskActual}    ${oriTaskNotes}
    [Teardown]    Test Sprint Backlog - Edit Task Teardown

Test Sprint Backlog - Drop Task
    [Setup]    Test Sprint Backlog - Drop Task Setup
    # task information
    ${taskName}=    Set Variable    task 1 for drop task
    ${taskEstimate}=    Set Variable    3
    ${taskNotes}=    Set Variable    notes for drop task
    # new task
    Comment    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    Comment    Add Task With Arguments    ${storyID}    ${taskName}    ${taskEstimate}    ${taskNotes}
    # drop task
    ${taskID}=    Get Task ID In Sprint Backlog    ${taskName}
    Drop Task With Arguments    ${taskName}
    # verify task information in Sprint Backlog
    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    Xpath Should Match X Times    //div[text()="${taskName}"]    0
    [Teardown]    Test Sprint Backlog - Drop Task Teardown

Test Sprint Backlog - Add Existing Task
    [Setup]    Test Sprint Backlog - Add Existing Task Setup
    ${taskCount}=    Set Variable    4
    ${taskEstimate}=    Set Variable    3
    ${taskNotes}=    Set Variable    notes for add existing task
    @{taskNameList}=    Create List
    @{taskIDList}=    Create List
    # new task
    : FOR    ${index}    IN RANGE    1    ${taskCount}
    \    ${taskName}=    Set Variable    task ${index} for add existing task
    \    Append To List    ${taskNameList}    ${taskName}
    \    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    \    Add Task With Arguments    ${storyID}    ${taskName}    ${taskEstimate}    ${taskNotes}
    \    ${taskID}=    Get Task ID In Sprint Backlog    ${taskName}
    \    Append To List    ${taskIDList}    ${taskID}
    # drop task
    : FOR    ${id}    IN    @{taskNameList}
    \    Drop Task With Arguments    ${id}
    # show add existing tasks window
    Add Existing Task With Arguments    ${storyName}    @{taskIDList}
    # verify story and task information
    ${idCount}=    Get Length    ${taskIDList}
    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    : FOR    ${index}    IN RANGE    ${idCount}
    \    ${correctTaskID}=    Get From List    ${taskIDList}    ${index}
    \    ${correctTaskName}=    Get From List    ${taskNameList}    ${index}
    \    Xpath Should Match X Times    //table[@class="x-treegrid-root-table"]//div[text()="${correctTaskName}"]    1
    [Teardown]    Test Sprint Backlog - Add Existing Task Teardown

Test Sprint Backlog - Show Task History
    [Setup]    Test Sprint Backlog - Show Task History Setup
    Comment    ${taskName}=    Set Variable    task for show task history
    Comment    ${taskEstimate}=    Set Variable    3
    Comment    ${taskNotes}=    Set Variable    notes for show task history
    Comment    # new task
    Comment    ${storyID}=    Get Story ID In Sprint Backlog    ${storyName}
    Comment    Add Task With Arguments    ${storyID}    ${taskName}    ${taskEstimate}    ${taskNotes}
    Comment    # show task history
    Comment    ${taskID}=    Get Task ID In Sprint Backlog    ${taskName}
    Comment    Show Task History With Arguments    ${taskID}    ${taskName}
    [Teardown]    Test Sprint Backlog - Show Task History Teardown

Test Sprint Backlog - Printable Task
    [Setup]    Test Sprint Backlog - Printable Task Setup    Printable_Task1.sql
    Click Element    xpath=//div[text()="Project01"]
    Select Node Product    Sprint Backlog
    Click Element    xpath=//button[text()="Printable Tasks"]
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[1]/table/tbody/tr/td[2]    1
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[2]/table/tbody/tr/td[2]    2
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[3]/table/tbody/tr/td[2]    3
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[1]/table/tbody/tr/td[3]    Task01
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[2]/table/tbody/tr/td[3]    Task02
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[3]/table/tbody/tr/td[3]    Task03
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[1]/table/tbody/tr/td[4]    1
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[2]/table/tbody/tr/td[4]    1
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[3]/table/tbody/tr/td[4]    2
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[1]/table/tbody/tr/td[5]    13
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[2]/table/tbody/tr/td[5]    5
    Compare Text In Specific Xpath    //div[text()="Id"]/../../../../../../../../div[2]/div/div[3]/table/tbody/tr/td[5]    5
    [Teardown]    Test Sprint Backlog - Printable Task Teardown

Test Sprint Backlog - Button Printable Stories Disabled Printable Tasks Disabled
    [Documentation]    [Button test] Printable Stories is Disabled, Printable Tasks is Disabled, when no stories and no tasks exist.
    [Setup]    Test Sprint Backlog - Button Printable Stories Disabled Printable Tasks Disabled Setup
    Wait Until Page Contains Element    //button[text()="Printable Stories"]
    Element Class Should Be Disabled    //table[@id="SprintBacklog_showPrintableStoryBtn"]
    Wait Until Page Contains Element    //button[text()="Printable Tasks"]
    Element Class Should Be Disabled    xpath=//table[@id="SprintBacklog_showPrintableTaskBtn"]
    [Teardown]    Test Sprint Backlog - Button Printable Stories Disabled Printable Tasks Disabled Teardown

Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Disabled
    [Documentation]    [Button test] Printable Stories is Enabled, Printable Tasks is Disabled, when story exists but no tasks.
    [Setup]    Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Disabled Setup
    Wait Until Page Contains Element    //button[text()="Printable Stories"]
    Element Class Should Be Enabled    //table[@id="SprintBacklog_showPrintableStoryBtn"]
    Wait Until Page Contains Element    //button[text()="Printable Tasks"]
    Element Class Should Be Disabled    xpath=//table[@id="SprintBacklog_showPrintableTaskBtn"]
    [Teardown]    Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Disabled Teardown

Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Enabled
    [Documentation]    [Button test] Printable Stories ->Enable, Printable Tasks ->Enable, when both story and task exist.
    [Setup]    Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Enabled Setup
    Wait Until Page Contains Element    //button[text()="Printable Stories"]
    Element Class Should Be Enabled    //table[@id="SprintBacklog_showPrintableStoryBtn"]
    Wait Until Page Contains Element    //button[text()="Printable Tasks"]
    Element Class Should Be Enabled    xpath=//table[@id="SprintBacklog_showPrintableTaskBtn"]
    [Teardown]    Test Sprint Backlog - Button Printable Stories Enabled Printable Tasks Enabled Teardown
