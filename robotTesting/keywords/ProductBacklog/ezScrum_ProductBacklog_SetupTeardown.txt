*** Settings ***
Library           ../lib/Selenium2Improved.py
Library           Collections
Resource          ../../Global Define.txt
Resource          ../common_resource.txt
Resource          ../ezScrum_Login.txt
Resource          ezScrum_ProductBacklog_Story.txt
Resource          ezScrum_ProductBacklog_Tag.txt
Resource          ezScrum_ProductBacklog_Search.txt
Resource          ezScrum_ProductBacklog_Filter.txt
Resource          ../SprintPlan/ezScrum_SprintPlan_Sprint.txt
Resource          ../ReleasePlan/ezScrum_ReleasePlan_Management.txt

*** Keywords ***
Test Product Backlog Suite Setup
    Comment    Login Page    ${LOGIN_URL}
    Comment    Wait Until Page Contains Element    createProjectBtn
    Comment    ${_IsProjectIDExisted}=    Check ProjectID Is Existed    ${PROJECT_NAME}
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="false"    Create Project
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="true"    Select Project    ${PROJECT_NAME}DisplayName
    Comment    Select Node Product    Product Backlog
    Comment    Clean All Tag
    Comment    Clean All Story
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}

Test Product Backlog Suite Teardown
    Comment    Clean All Tag
    Comment    Clean All Story
    Comment    Click Image    images/logout.gif
    Comment    Title Should Be    ezScrum Logon!
    Comment    Close Browser
    Comment    # clean DB
    Comment    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}

Test Product Backlog Create Story Identify Invalid Value Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Create_Story_Identify_Invalid_Value.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Product Backlog Create Story Identify Invalid Value Teardown
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Edit Story Identify Invalid Value Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Edit_Story_Identify_Invalid_Value.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog
    Comment    Create Story With Arguments    new Edit Story With Invalid Value    0    0    0    ${EMPTY}
    ...    "Note: newStoryNormal"    "HowToDemo: newStoryNormal"

Test Edit Story Identify Invalid Value Teardown
    Comment    Delete Story With Arguments    new Edit Story With Invalid Value
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Create Story Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Create_Story.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Create Story Teardown
    Comment    Delete Story With Arguments    newStory
    Comment    Delete Tag With Arguments    testTagName
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Create Story With Invalid Value Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Create_Story_Identify_Invalid_Value.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Create Story With Invalid Value Teardown
    [Arguments]    ${storyID}
    Comment    Delete Tag With Arguments    testTagName
    Comment    Delete Story Use StoryID    ${storyID}
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Edit Story Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Edit_Story.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog
    Comment    Create Tag With Arguments    testTagName
    Comment    Create Story With Arguments    oriStory    5    3    1    testTagName
    ...    Note: newStory    HowToDemo: newStory

Test Edit Story Teardown
    [Arguments]    ${storyID}
    Comment    Delete Tag With Arguments    testTagName
    Comment    Delete Story Use StoryID    ${storyID}
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Story History Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Story_History.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog
    Comment    Create Story With Arguments    newStory    5    3    1    ${EMPTY}
    ...    "Note: newStoryNote"    "HowToDemo: newStoryHowToDemo"
    Comment    Create Story With Arguments| newStory | 5 | 3 | 1 | ${EMPTY} | "Note: newStoryNote" | "HowToDemo: newStoryHowToDemo"

Test Story History Teardown
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Remove Story Tag Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Remove_Story_Tag.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog
    Comment    Create Tag With Arguments    testTagName
    Comment    Create Story With Arguments    newStory    5    3    1    testTagName
    ...    Note: newStory    HowToDemo: newStory

Test Remove Story Tag Teardown
    Comment    Delete Story With Arguments    newStory
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Create Tag Setup
    [Documentation]    建立兩種Tag: 正常字串 & 特殊字元
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Create_Story.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Create Tag Teardown
    [Documentation]    刪除兩種Tag: 正常字串 & 特殊字元
    Comment    # remove TestData
    Comment    Delete Tag
    Comment    Delete Tag
    Comment    # close Tag Manage window
    Comment    ${xpathTagManageClose}=    Find Current Window Element    Tag Manage    Close
    Comment    Click Element    xpath=${xpathTagManageClose}
    ${xpathTagManage} =    Find Current Window Element    Tag Manage    Close
    Click Element    xpath=${xpathTagManage}
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Duplicate Tag Setup
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Duplicate_Tag.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Duplicate Tag Teardown
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Mark And UnMark Story Tag Setup
    Create Tag With Arguments    markAndUnMarkTag
    Create Story With Arguments    newStory    5    3    1    ${EMPTY}    Note: newStory
    ...    HowToDemo: newStory

Test Mark And UnMark Story Tag Teardown
    Delete Tag With Arguments    markAndUnMarkTag
    Delete Story With Arguments    newStory

Test Delete Tag Setup
    [Arguments]    ${tagCount}
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Delete_Tag.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog
    # open Tag Manage window
    Click Element    xpath=//button[text()="Manage Tag"]
    Comment    # add Tag
    Comment    : FOR    ${index}    IN RANGE    1    ${tagCount} + 1
    Comment    \    Create Tag    ${tsTag}_${index}

Test Delete Tag Teardown
    # close Tag Manage window
    ${xpathTagManageClose}=    Find Current Window Element    Tag Manage    Close
    Click Element    xpath=${xpathTagManageClose}
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Product Backlog Filter Setup
    Comment    # 建立測試資料
    Comment    Create Story With Arguments    newStoryNormal    0    0    0    ${EMPTY}
    ...    "Note: newStoryNormal"    "HowToDemo: newStoryNormal"
    Comment    Create Story With Arguments    newStoryBacklogged    0    0    0    ${EMPTY}
    ...    "Note: newStoryBacklogged"    "HowToDemo: newStoryBacklogged"
    Comment    Create Story With Arguments    newStoryDetailed    5    5    5    ${EMPTY}
    ...    "Note: newStoryDetailed"    "HowToDemo: newStoryDetailed"
    Comment    Create Story With Arguments    newStoryDone    8    8    8    ${EMPTY}
    ...    "Note: newStoryDone"    "HowToDemo: newStoryDone"
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    ProductBacklog    Product_Backlog_Filter.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    #Select project
    Select Project    localtestProjectDisplayName
    Select Node Product    Product Backlog

Test Product Backlog Filter Teardown
    # 刪除測試資料
    Comment    Delete Story With Arguments    newStoryNormal
    Comment    Delete Story With Arguments    newStoryBacklogged
    Comment    Delete Story With Arguments    newStoryDetailed
    Comment    Delete Story With Arguments    newStoryDone
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Product Backlog Done Filter Teardown
    # 刪除測試資料
    Delete Story With Arguments    newStoryNormal
    Delete Story With Arguments    newStoryBacklogged
    Delete Story With Arguments    newStoryDetailed
    Delete Story With Arguments    newStoryDone
    Clean All Sprint

Test Product Backlog Search Setup
    # 新增story
    Create Story With Arguments    newStoryFirst    1    1    1    ${EMPTY}    newStoryFirstNote
    ...    newStoryFirstHowToDemo
    Create Story With Arguments    newStorySecond    3    3    3    ${EMPTY}    newStorySecondNote
    ...    newStorySecondHowToDemo
    Create Story With Arguments    newStoryThird    5    5    5    ${EMPTY}    newStoryThirdNote
    ...    newStoryThirdHowToDemo
    Create Story With Arguments    newStoryFourth    8    8    8    ${EMPTY}    newStoryFourthNote
    ...    newStoryFourthHowToDemo
    Create Story With Arguments    newStoryFifth    8    8    8    ${EMPTY}    newStoryFifthNote
    ...    newStoryFifthHowToDemo
    # 新增Sprint
    Select Node Product    Sprint Plan
    ${sprintStartDate}=    Get Start Date    NOW
    Create Sprint with Date    sprint1 in A    ${sprintStartDate}    2    4    100    100
    ${sprintStartDate}=    Get Start Date    NOW +14d
    Create Sprint with Date    sprint2 in A    ${sprintStartDate}    2    4    100    100
    # 將story加到sprint
    Select Node Product    Sprint Backlog
    Click Element    xpath=//div[@id="sprintAction"]//button[text()="Add Existing Stories"]
    Wait Until Page Contains Element    xpath=//div[@id="AddExistedStory_Window"]//span[text()="Select Existed Stories"]
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-4" and (text()="newStoryFourth")]
    Mouse Up    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-4" and (text()="newStoryFourth")]
    Click Element    xpath=//button[text()="Add Existed Stories"]
    Wait Until Page Contains    Add Existing Stories
    Click Element    xpath=//table[@id="SprintBacklog_nextSprintBtn"]//button    # 切換到下一個sprint
    Click Element    xpath=//div[@id="sprintAction"]//button[text()="Add Existing Stories"]
    Wait Until Page Contains Element    xpath=//div[@id="AddExistedStory_Window"]//span[text()="Select Existed Stories"]
    Mouse Down    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-4" and (text()="newStoryFifth")]
    Mouse Up    xpath=//div[@class="x-grid3-cell-inner x-grid3-col-4" and (text()="newStoryFifth")]
    Click Element    xpath=//button[text()="Add Existed Stories"]
    # 新增Release
    Select Node Product    Release Plan
    ${sprintStartDate}=    Get Start Date    NOW
    ${sprintEndDate}=    Get Start Date    NOW +28d
    @{tsReleasePlan}=    Create List    testReleasePlan    ${sprintStartDate}    ${sprintEndDate}    test Release Plan Description
    NewReleasePlan    @{tsReleasePlan}

Test Product Backlog Search Teardown
    [Documentation]    先重新整理進入product backlog將搜尋狀態清除(由於無法直接透過點選Please Select ...清除搜尋結果)，
    ...    再將所建立的story刪除
    Reload Page
    Title Should Be    ezScrum, SSLab NTUT
    Select Node Product    Product Backlog
    Page Should Contain Element    xpath=//div[@id="productBacklogMasterPanel"]//span[text()="Product Backlog"]
    Clean All Story
    Clean All Sprint
    Clean Release
